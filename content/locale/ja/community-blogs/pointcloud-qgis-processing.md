---
source: "blog"
title: "Lutra Consulting: Native point cloud processing in QGIS"
image: "pointcloud-qgis-processing."
date: "2023-05-31"
link: "https://lutraconsulting.co.uk/blog/2023/05/30/pointcloud-qgis-processing/"
draft: "true"
showcase: "planet"
---

<p>After the addition of support for visualising point clouds in the recent versions of QGIS, the next step was to add the processing tools so users can manage and analyse their data.</p>

<p>There are several 3rd party QGIS plugins (either proprietary or not fully open source) which allow users to interrogate and analyse lidar data. But with our latest work, we have introduced powerful point cloud algorithms to the QGIS Processing framework. All the algorithms are available out of the box in QGIS 3.32, with no need to install plugins.</p>

<p>In this blog post, we summarise the initial point cloud algorithms for QGIS Processing toolbox which will be available in QGIS 3.32 (to be released at the end of June 2023). This work was made possible by the generous donations to our <a href="https://www.lutraconsulting.co.uk/crowdfunding/pointcloud-processing-qgis/">crowdfunding</a>.</p>

<h2 id="point-cloud-algorithms-in-qgis">Point Cloud algorithms in QGIS</h2>

<p>First off a quick look at the new algorithms as shown in the Processing toolbox in three groups:</p>

<center>
  <p><img title="Point Cloud algorithms in QGIS processing toolbox" src="https://lutraconsulting.co.uk/img/posts/pc3_processing_toolbox.png" alt="Point Cloud algorithms in QGIS processing toolbox" /></p>
  Point Cloud algorithms in QGIS processing toolbox
</center>

<ul>
  <li><strong>Convert formats</strong>: this will allow you to convert your point cloud data between LAS and LAZ formats for the time being. Other PDAL supported formats can be added later.</li>
  <li><strong>Export to raster</strong>: with this algorithm you can export point cloud to a regularly gridded raster data. It uses inverse distance weighting to assign raster cell values. Raster cells with no nearby points will get “no data” values (these holes may be removed by using “Fill nodata” raster algorithm).</li>
</ul>

<center>
  <p><img title="Input point cloud layer file" src="https://lutraconsulting.co.uk/img/posts/pc3_processing_input.png" alt="Input point cloud layer file" /></p>
  Input point cloud layer file
  <p><img title="Raster output using Intensity attribute of points" src="https://lutraconsulting.co.uk/img/posts/pc3_processing_intensity.png" alt="Raster output using Intensity attribute of points" /></p>
  Raster output using Intensity attribute of points
</center>

<ul>
  <li><strong>Export to raster (using triangulation)</strong>: this allows you to export Z data to a regularly gridded raster by interpolating between the points using triangulation. Note that this can be slower if you are dealing with a large dataset. If your point cloud is dense, you can export your ground points as a raster using the Export to raster algorithm.</li>
</ul>

<center>
  <p><img title="Terrain raster output generated by point cloud triangulation" src="https://lutraconsulting.co.uk/img/posts/pc3_processing_dtm.png" alt="Terrain raster output generated by point cloud triangulation" /></p>
  Terrain raster output generated by point cloud triangulation
</center>

<ul>
  <li><strong>Export to vector</strong>: to export point cloud to other vector formats. This is useful to export some of your data for software applications which do not support point cloud data and still use formats such as CSV, Shapefile, DXF.</li>
</ul>

<center>
  <p><img title="Exporting point cloud (ground points) to Shapefile styled based on the elevation" src="https://lutraconsulting.co.uk/img/posts/pc3_processing_pnt_vector.png" alt="Exporting point cloud (ground points) to Shapefile styled based on the elevation" /></p>
  Exporting point cloud (ground points) to Shapefile styled based on the elevation!
</center>

<ul>
  <li><strong>Assign projection</strong>: assigns a projection to a point cloud layer (if it is wrong or missing)</li>
  <li><strong>Build virtual point cloud (VPC)</strong>: with this algorithm you can generate a virtual file (based on STAC specification) and load them as a single file in QGIS. There will be a separate blog post detailing this new exciting feature.</li>
  <li><strong>Clip</strong>: clip a point cloud layer by a vector polygon layer.</li>
</ul>

<center>
  <p><img title="Input point cloud layer and a polygon coverage" src="https://lutraconsulting.co.uk/img/posts/pc3_processing_clipin.png" alt="Input point cloud layer and a polygon coverage" /></p>
  Input point cloud layer and a polygon coverage
  <p><img title="Result of the clipping algorithm" src="https://lutraconsulting.co.uk/img/posts/pc3_processing_clipout.png" alt="Result of the clipping algorithm" /></p>
  Result of the clipping algorithm
</center>

<ul>
  <li><strong>Create COPC</strong>: when you load a non-indexed point cloud layer in QGIS, it will take a while for the application to create the COPC index for your file. With this algorithm, you can create the index for all your files in a batch mode.</li>
  <li><strong>Information</strong>: displays information from a point cloud layer:</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>LAS           1.4
point format  6
count         56736130
scale         0.001 0.001 0.001
offset        431749.999 5440919.999 968.898
extent        431250 5440420 424.266
              432249.999 5441419.999 1513.531
crs           ETRS89 / UTM zone 34N (N-E) (EPSG:3046)  (vertical CRS missing!)
units         horizontal=metre  vertical=unknown

Attributes:
 - X floating 8
 - Y floating 8
 - Z floating 8
 - Intensity unsigned 2
 - ReturnNumber unsigned 1
 - NumberOfReturns unsigned 1
 - ScanDirectionFlag unsigned 1
 - EdgeOfFlightLine unsigned 1
 - Classification unsigned 1
 - ScanAngleRank floating 4
 - UserData unsigned 1
 - PointSourceId unsigned 2
 - GpsTime floating 8
 - ScanChannel unsigned 1
 - ClassFlags unsigned 1
</code></pre></div></div>
<center>
 <p>Output from point cloud information algorithm</p>
</center>

<ul>
  <li><strong>Merge</strong>: join multiple point cloud layers into a single file</li>
  <li><strong>Reproject</strong>: reproject the input file to a different coordinate reference system</li>
  <li><strong>Thin (by sampling radius)</strong>: reduces the number of points within a certain radius</li>
</ul>

<center>
  <p><img title="Thining point cloud (by sampling radius)" src="https://lutraconsulting.co.uk/img/posts/pc3_processing_thinning.gif" alt="Thining point cloud (by sampling radius)" /></p>
  Thining point cloud (by sampling radius)
</center>

<ul>
  <li><strong>Thin (by skipping points)</strong>: reduces the number of points by skipping nearby points</li>
  <li><strong>Tile</strong>: this algorithm generates a set of tiles based on the input point cloud layer and tile size</li>
  <li><strong>Boundary</strong>: generates a (multi) polygon from your point cloud data. The output file might contain holes depending on the density of your point cloud input data.</li>
</ul>

<center>
  <p><img title="Extracting high vegetation and building polygons from an input point cloud layer" src="https://lutraconsulting.co.uk/img/posts/pc3_processing_boundary.png" alt="Extracting high vegetation and building polygons from an input point cloud layer" /></p>
  Extracting high vegetation and building polygons from an input point cloud layer
</center>

<ul>
  <li><strong>Density</strong>: outputs a raster file based on the number of points within each raster cell - useful for quality checking of point cloud datasets</li>
</ul>

<center>
  <p><img title="Point density (number of points per 2x2 m)  as a raster" src="https://lutraconsulting.co.uk/img/posts/pc3_processing_density.png" alt="Point density (number of points per 2x2 m)  as a raster" /></p>
  Point density (number of points per 2x2 m)  as a raster
</center>

<ul>
  <li><strong>Filter</strong>: it creates a new file based on the filter set as an expression. Note that most of the algorithms support on-the-fly filtering under the Advanced parameters.</li>
</ul>

<center>
  <p><img title="Filtering of high vegetation class from an input point cloud layer" src="https://lutraconsulting.co.uk/img/posts/pc3_processing_filtering.png" alt="Filtering of high vegetation class from an input point cloud layer" /></p>
  Filtering of high vegetation class from an input point cloud layer
</center>

<h2 id="behind-the-scenes">Behind the scenes</h2>

<p>All the heavy lifting of the point cloud processing is done by PDAL - a state of the art open source library for processing point clouds. PDAL provides a wide range of “readers”, “filters” and “writers” to build complex pipelines to process point clouds.</p>

<p>We have built a new standalone command line tool <a href="https://github.com/PDAL/wrench">pdal_wrench</a> on top of PDAL. It addresses two major issues that non-expert users typically face when working with PDAL:</p>

<ul>
  <li><strong>Ease of use</strong>: not everyone finds it easy to manually craft JSON files with pipelines, study manuals of the many stages and read details about file formats involved.</li>
  <li><strong>Parallel execution</strong>: PDAL runs pipelines in a single thread, so only one CPU gets to do the work normally and users need to implement their own parallelism if they want to speed up processing.</li>
</ul>

<p>The command line tool provides a simple set of commands that take care of everything. For example, to export a raster layer with elevations (DEM) with 1 meter resolution:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pdal_wrench to_raster --output=raster.tif --resolution=1 --attribute=Z data.las
</code></pre></div></div>

<p>The pdal_wrench tool does not depend on QGIS, so it can be easily used separately.</p>

<p>The commands are designed to run in parallel when there are multiple input files or when the input file is in COPC format. Depending on the algorithm, the work gets split spatially into square tiles (1000x1000 map units by default) for parallel processing, or individual files are processed in parallel. With a single ordinary LAS/LAZ file on input, there is currently no parallelism going on.</p>

<p>For commands that are sensitive to edge artifacts (such as export to raster), we take care of processing extra points outside of the extent of each tile (referred to as collar or buffer) to make sure the results are correct as if no tiling would be happening (see Martin Isenburg’s article for more details: https://rapidlasso.com/2015/08/07/use-buffers-when-processing-lidar-in-tiles/).</p>

<h2 id="future-work">Future work</h2>

<p>The current list of point cloud algorithms already allows users to do plenty of work. But more could be added to the toolbox - algorithms that are already supported by PDAL, but not exposed in QGIS: classification, noise removal, surface reconstruction, clustering, height above ground, colorizing and many more. If you are interested in more point cloud processing algorithms in QGIS, please  <a href="mailto:info@lutraconsulting.co.uk">contact us</a> and we will be happy to add them to future QGIS releases.</p>
